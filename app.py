import os
from flask import Flask, request, jsonify, Response
import requests
from bs4 import BeautifulSoup
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from flask_cors import CORS
from symspellpy import SymSpell, Verbosity
import whisper
import soundfile as sf
import io
import torch
import numpy as np
import nltk
from nltk.corpus import stopwords
import re
from sentence_transformers import SentenceTransformer, util

app = Flask(__name__, static_folder='static', static_url_path='')
CORS(app)

@app.route('/')
def index():
    """Serves the index.html file from the 'static' folder at the root URL."""
    return app.send_static_file('index.html')

# ----------------------------------------------------------------
# 1) SPELLING CORRECTION (SymSpell)
# ----------------------------------------------------------------
sym_spell = SymSpell(max_dictionary_edit_distance=2, prefix_length=7)
sym_spell.load_dictionary("es_50k.txt", term_index=0, count_index=1)

@app.route('/correct_spelling', methods=['POST'])
def correct_spelling():
    data = request.get_json()
    user_input = data.get("query", "")
    corrected_words = []
    for word in user_input.split():
        suggestions = sym_spell.lookup(word, Verbosity.CLOSEST, max_edit_distance=2)
        corrected_word = suggestions[0].term if suggestions else word
        corrected_words.append(corrected_word)
    corrected_query = " ".join(corrected_words)
    return jsonify({"corrected_query": corrected_query})

def correct_spelling_internal(text):
    corrected_words = []
    for word in text.split():
        suggestions = sym_spell.lookup(word, Verbosity.CLOSEST, max_edit_distance=2)
        corrected_word = suggestions[0].term if suggestions else word
        corrected_words.append(corrected_word)
    return " ".join(corrected_words)

# ----------------------------------------------------------------
# 2) WEB SCRAPING & TF-IDF
# ----------------------------------------------------------------
def scrape_page(url):
    try:
        response = requests.get(url)
        response.raise_for_status()
        soup = BeautifulSoup(response.text, "html.parser")
        paragraphs = soup.find_all('p')
        page_text = " ".join(p.get_text() for p in paragraphs)
        return page_text.strip()
    except Exception as e:
        print(f"Error scraping {url}: {e}")
        return ""

urls = [
    "https://uma.edu.pe/",
    "https://uma.edu.pe/alumni/",
    "https://uma.edu.pe/docentes/",
    "https://uma.edu.pe/contactos/",
    "https://uma.edu.pe/curso-ia40/",
    "https://uma.edu.pe/por-que-la-uma/",
    "https://uma.edu.pe/admisionpregrado/",
    "https://uma.edu.pe/noticias/",
    "https://uma.edu.pe/convenios-internacionales/",
    "https://uma.edu.pe/convenios-nacionales/"
]

documents = []
for url in urls:
    text = scrape_page(url)
    if text:
        documents.append(text)
if not documents:
    documents.append("No data available.")

nltk.download('stopwords')
spanish_stopwords = stopwords.words('spanish')
vectorizer = TfidfVectorizer(stop_words=spanish_stopwords)
doc_vectors = vectorizer.fit_transform(documents)

def get_best_doc_and_score(query):
    query_vec = vectorizer.transform([query])
    similarities = cosine_similarity(query_vec, doc_vectors).flatten()
    best_idx = similarities.argmax()
    best_doc = documents[best_idx]
    best_score = similarities[best_idx]
    UMA_KEYWORDS = ["curso", "cursos", "admisi√≥n", "facultad", "estudios", "clases", "universidad"]
    if any(keyword in query.lower() for keyword in UMA_KEYWORDS) and best_score < 0.3:
        best_score += 0.1
    return best_doc, best_score

def normalize_text(text):
    text = text.lower()
    text = re.sub(r'[^\w\s√°√©√≠√≥√∫√±√º]', '', text)
    text = re.sub(r'\s+', ' ', text).strip()
    return text

# ----------------------------------------------------------------
# 3) FAQ with SYNONYMS & STRONG EMBEDDING MODEL
# ----------------------------------------------------------------
# We'll embed the question + synonyms as a single string for better matching.
# The user can ask in different ways, but if it matches synonyms, we get a high similarity.

faq_list = [
    # Coordinaci√≥n Acad√©mica
    {
        "question": "¬øCu√°ndo inicia la matr√≠cula para el pr√≥ximo ciclo?",
        "synonyms": [
            "inicio de matr√≠cula", "fecha de matr√≠cula", "pr√≥ximo semestre", "fechas de matr√≠cula"
        ],
        "answer": """Las fechas de matr√≠cula var√≠an seg√∫n el calendario acad√©mico. 
Puedes consultar las fechas actualizadas contactando a Coordinaci√≥n Acad√©mica:
üìû (01) 389-1212 Anexo 318
üì± WhatsApp: 933 670 445
üìß coacademica@uma.edu.pe"""
    },
    {
        "question": "¬øC√≥mo solicito un cambio de turno o secci√≥n?",
        "synonyms": [
            "cambio de turno", "cambio de secci√≥n", "modificar turno", "solicitar cambio de secci√≥n"
        ],
        "answer": """Para solicitar un cambio de turno o secci√≥n, debes presentar tu solicitud 
a Coordinaci√≥n Acad√©mica dentro de las fechas establecidas. Puedes contactarlos para m√°s detalles."""
    },
    {
        "question": "¬øQu√© hago si tengo un problema con mi horario de clases?",
        "synonyms": [
            "problema con horario", "inconvenientes con mi horario", "clase solapada", "conflicto de horario"
        ],
        "answer": """Si tienes inconvenientes con tu horario, debes comunicarte con Coordinaci√≥n Acad√©mica 
lo antes posible para revisar tu caso y encontrar una soluci√≥n."""
    },
    {
        "question": "¬øC√≥mo puedo solicitar un curso adelantado?",
        "synonyms": [
            "curso adelantado", "adelantar curso", "tomar curso antes", "curso anticipado"
        ],
        "answer": """Para adelantar un curso, debes cumplir con los requisitos acad√©micos 
y presentar tu solicitud a Coordinaci√≥n Acad√©mica. Cont√°ctanos para m√°s detalles."""
    },
    {
        "question": "¬øCu√°ntas veces puedo desaprobar un curso antes de ser retirado?",
        "synonyms": [
            "desaprobar curso", "l√≠mite de desaprobaciones", "fail a course", "cu√°ntas veces puedo desaprobar"
        ],
        "answer": """Seg√∫n el reglamento acad√©mico, existe un l√≠mite de desaprobaciones antes de ser dado de baja en la asignatura. 
Te recomendamos revisar el reglamento o contactar a Coordinaci√≥n Acad√©mica."""
    },
    {
        "question": "¬øC√≥mo puedo solicitar una reubicaci√≥n en un grupo de clases?",
        "synonyms": [
            "reubicaci√≥n de grupo", "cambio de grupo", "moverse de secci√≥n"
        ],
        "answer": """Debes presentar una solicitud formal indicando el motivo. 
La aprobaci√≥n depender√° de la disponibilidad de cupos."""
    },
    {
        "question": "¬øCu√°les son los requisitos para egresar de mi carrera?",
        "synonyms": [
            "requisitos de egreso", "graduaci√≥n requisitos", "terminar carrera"
        ],
        "answer": """Debes haber aprobado todos los cursos del plan de estudios, cumplir con el trabajo de titulaci√≥n 
y no tener deudas pendientes con la universidad."""
    },
    # Oficina de Tesorer√≠a
    {
        "question": "¬øCu√°les son las opciones de pago de mis pensiones?",
        "synonyms": [
            "formas de pago pensi√≥n", "pago de pensiones", "pago de mensualidad", "pago de matr√≠cula"
        ],
        "answer": """Puedes pagar tus pensiones mediante transferencia bancaria, pago en ventanilla 
o a trav√©s de la plataforma virtual de la universidad. Para m√°s informaci√≥n:
üìû (01) 389-1212 Anexo 321
üì± WhatsApp: 970 408 211
üìß contactotesoreria@uma.edu.pe"""
    },
    {
        "question": "¬øD√≥nde veo mi estado de cuenta?",
        "synonyms": [
            "ver mi cuenta", "consultar balance", "estado de cuenta pensi√≥n"
        ],
        "answer": """Puedes consultar tu estado de cuenta en la plataforma de autoservicio 
de la universidad o comunic√°ndote con Tesorer√≠a."""
    },
    {
        "question": "¬øPuedo fraccionar el pago de mi pensi√≥n?",
        "synonyms": [
            "pago en partes", "fraccionar pensi√≥n", "pago fraccionado"
        ],
        "answer": """S√≠, la universidad ofrece opciones de fraccionamiento. 
Debes coordinarlo directamente con Tesorer√≠a."""
    },
    {
        "question": "¬øQu√© sucede si no pago mi pensi√≥n a tiempo?",
        "synonyms": [
            "pago tard√≠o pensi√≥n", "no pagu√© pensi√≥n", "pagar fuera de fecha"
        ],
        "answer": """Si no realizas el pago en la fecha establecida, se generar√°n intereses moratorios 
y podr√≠as tener restricciones acad√©micas."""
    },
    {
        "question": "¬øPuedo pagar mi matr√≠cula con tarjeta de cr√©dito?",
        "synonyms": [
            "pagar con tarjeta", "tarjeta de cr√©dito", "tarjeta de d√©bito", "pago con tarjeta"
        ],
        "answer": """S√≠, aceptamos pagos con tarjeta de cr√©dito o d√©bito. 
Puedes realizarlo en l√≠nea o en la Tesorer√≠a de la universidad."""
    },
    {
        "question": "¬øCu√°les son los bancos afiliados para el pago de pensiones?",
        "synonyms": [
            "bancos afiliados", "bancos convenio", "d√≥nde pagar pensiones"
        ],
        "answer": """Puedes realizar pagos en los bancos con los que la universidad tiene convenio. 
Para m√°s detalles, contacta con Tesorer√≠a."""
    },
    {
        "question": "¬øC√≥mo solicito un comprobante de pago?",
        "synonyms": [
            "comprobante de pago", "recibo de pago", "proof of payment"
        ],
        "answer": """Puedes solicitarlo directamente en Tesorer√≠a o mediante 
el correo electr√≥nico oficial."""
    },
    # Oficina de Servicios Acad√©micos (OSAR)
    {
        "question": "¬øC√≥mo solicito un certificado de estudios?",
        "synonyms": [
            "certificado de estudios", "transcript", "solicitar certificado"
        ],
        "answer": """Debes solicitarlo en la Oficina de Servicios Acad√©micos (OSAR) 
y pagar el derecho correspondiente en tu plataforma SIGU. M√°s informaci√≥n en:
üìû (01) 389-1212 Anexo 313
üì± WhatsApp: 934 563 160
üìß osar@uma.edu.pe"""
    },
    {
        "question": "¬øCu√°nto tiempo demora la emisi√≥n de una constancia de matr√≠cula?",
        "synonyms": [
            "tiempo constancia de matr√≠cula", "demora constancia matr√≠cula", "issue registration certificate"
        ],
        "answer": """El tiempo de emisi√≥n var√≠a, pero generalmente es entre 3 a 5 d√≠as h√°biles."""
    },
    {
        "question": "¬øC√≥mo solicito la reprogramaci√≥n de un examen?",
        "synonyms": [
            "reprogramar examen", "examen fuera de fecha", "examen reprogramaci√≥n"
        ],
        "answer": """Para reprogramar un examen, debes presentar una solicitud justificada 
ante OSAR dentro del plazo establecido."""
    },
    {
        "question": "¬øC√≥mo puedo tramitar mi carn√© universitario?",
        "synonyms": [
            "carn√© universitario", "id de estudiante", "tarjeta de estudiante"
        ],
        "answer": """Debes acercarte a OSAR y presentar tu solicitud junto con 
el pago correspondiente."""
    },
    {
        "question": "¬øQu√© debo hacer si mi nombre aparece con un error en los documentos oficiales?",
        "synonyms": [
            "error en nombre", "nombre incorrecto", "documentos con error"
        ],
        "answer": """Debes presentar una solicitud de correcci√≥n junto con una copia de tu documento de identidad."""
    },
    {
        "question": "¬øC√≥mo solicito la reserva de matr√≠cula?",
        "synonyms": [
            "reserva de matr√≠cula", "reservar matr√≠cula", "enrollment reservation"
        ],
        "answer": """Para reservar tu matr√≠cula, debes presentar una solicitud dentro de las fechas establecidas 
y cumplir con los requisitos administrativos."""
    },
    {
        "question": "¬øD√≥nde solicito una constancia de egresado?",
        "synonyms": [
            "constancia de egresado", "certificado de egresado", "egresado certificate"
        ],
        "answer": """En la Oficina de Servicios Acad√©micos, presentando una solicitud 
y pagando el derecho correspondiente dentro de tu plataforma SIGU."""
    },
    # Tecnolog√≠a de la Informaci√≥n
    {
        "question": "Olvid√© mi contrase√±a del aula virtual, ¬øc√≥mo la recupero?",
        "synonyms": [
            "restablecer contrase√±a aula virtual", "olvid√© mi password", "contrase√±a plataforma"
        ],
        "answer": """Puedes restablecer tu contrase√±a en la plataforma o comunicarte con el √°rea de TI:
üìû (01) 389-1212 Anexos 334 / 317
üì± WhatsApp: 982 888 601
üìß soporte.online@uma.edu.pe"""
    },
    {
        "question": "¬øQu√© hago si la plataforma virtual no carga?",
        "synonyms": [
            "problemas plataforma virtual", "no carga el aula", "error al cargar"
        ],
        "answer": """Intenta limpiar la cach√© de tu navegador o usar otro dispositivo. 
Si el problema persiste, contacta a Tecnolog√≠a de la Informaci√≥n."""
    },
    {
        "question": "¬øC√≥mo accedo al Wi-Fi de la universidad?",
        "synonyms": [
            "conectarme wifi", "wifi universidad", "acceso wifi", "contrase√±a wifi"
        ],
        "answer": """Deberas conectarte a la red COMUNIDAD UMA con la contrase√±a @uMa.2024@"""
    },
    {
        "question": "¬øC√≥mo recupero mi acceso a la plataforma si olvid√© mi contrase√±a?",
        "synonyms": [
            "olvid√© mi contrase√±a", "no puedo entrar plataforma", "reset password"
        ],
        "answer": """Puedes restablecerla en la opci√≥n "Olvid√© mi contrase√±a" en la plataforma. 
Si persiste el problema, cont√°ctanos."""
    },
    {
        "question": "¬øQu√© hago si no puedo acceder a mi correo institucional?",
        "synonyms": [
            "correo institucional inaccesible", "email no funciona", "problema con correo"
        ],
        "answer": """Verifica tu conexi√≥n a internet e intenta restablecer la contrase√±a. 
Si sigues teniendo problemas, contacta a Tecnolog√≠a de la Informaci√≥n."""
    },
    {
        "question": "¬øD√≥nde reporto problemas con la red Wi-Fi de la universidad?",
        "synonyms": [
            "problemas con wifi", "reportar wifi", "wifi no funciona"
        ],
        "answer": """Puedes reportarlo directamente en el √°rea de Tecnolog√≠a de la Informaci√≥n 
o a trav√©s del correo de soporte."""
    },
    # Mesa de Partes
    {
        "question": "¬øC√≥mo presento una solicitud en Mesa de Partes?",
        "synonyms": [
            "solicitud mesa de partes", "enviar solicitud", "tramitar en mesa de partes"
        ],
        "answer": """Puedes presentar tu solicitud presencialmente o enviarla por correo electr√≥nico a:
üìû (01) 389-1212 Anexo 322
üì± WhatsApp: 982 887 539
üìß mesadepartes@uma.edu.pe"""
    },
    {
        "question": "¬øCu√°nto tiempo tarda en procesarse mi tr√°mite?",
        "synonyms": [
            "tiempo tr√°mite", "demora tr√°mite", "procesar mi solicitud"
        ],
        "answer": """El tiempo de respuesta var√≠a seg√∫n el tipo de tr√°mite. 
Puedes hacer seguimiento comunic√°ndote con Mesa de Partes o en tu plataforma SIGU 
en la opci√≥n Mis tramites y pagos ‚Äì Mis tramites."""
    },
    {
        "question": "¬øQu√© tipo de documentos puedo presentar en Mesa de Partes?",
        "synonyms": [
            "documentos mesa de partes", "qu√© se presenta en mesa de partes", "solicitudes mesa de partes"
        ],
        "answer": """Puedes presentar solicitudes acad√©micas, administrativas y documentos oficiales 
dirigidos a las diferentes √°reas de la universidad."""
    },
    {
        "question": "¬øPuedo hacer un tr√°mite de forma virtual?",
        "synonyms": [
            "tr√°mite virtual", "tramite online", "hacer tr√°mite digital"
        ],
        "answer": """S√≠, todos los tr√°mites pueden ser generados por tu plataforma SIGU. 
Contacta con Mesa de Partes para conocer los requisitos."""
    },
    {
        "question": "¬øC√≥mo s√© si mi tr√°mite ha sido aprobado?",
        "synonyms": [
            "verificar tr√°mite", "estado de mi tr√°mite", "mi solicitud fue aprobada"
        ],
        "answer": """Puedes hacer el seguimiento a trav√©s de tu plataforma SIGU en la opci√≥n Mis Tramites 
o contactando a Mesa de Partes."""
    },
    {
        "question": "¬øCu√°l es el horario de atenci√≥n de Mesa de Partes?",
        "synonyms": [
            "horario mesa de partes", "horas de atenci√≥n", "cuando abre mesa de partes"
        ],
        "answer": """El horario de atenci√≥n es de lunes a viernes en horario de oficina."""
    },
    # Educaci√≥n Virtual
    {
        "question": "¬øC√≥mo accedo a mis clases virtuales?",
        "synonyms": [
            "clases online", "entrar a aula virtual", "acceso clases virtuales"
        ],
        "answer": """Debes ingresar a la plataforma virtual de la universidad con tu usuario y contrase√±a. 
Si tienes problemas, contacta a Educaci√≥n Virtual:
üìû (01) 389-1212 Anexo 304
üìß educacion.virtual@uma.edu.pe"""
    },
    {
        "question": "¬øD√≥nde encuentro el material de mis cursos en la plataforma?",
        "synonyms": [
            "material de cursos", "recursos en aula virtual", "documentos de clase"
        ],
        "answer": """Puedes encontrar el material en la secci√≥n "Recursos" dentro de cada curso en tu Aula Virtual."""
    },
    {
        "question": "¬øQu√© hago si mi examen virtual no se envi√≥ correctamente?",
        "synonyms": [
            "examen virtual fall√≥", "examen no se envi√≥", "error en examen online"
        ],
        "answer": """Debes reportarlo de inmediato a Educaci√≥n Virtual con una captura de pantalla del problema."""
    },
    {
        "question": "¬øC√≥mo accedo a mi aula virtual?",
        "synonyms": [
            "acceder a la plataforma", "ingresar al campus virtual", "entrar a la aula"
        ],
        "answer": """Debes ingresar a la plataforma con tu usuario y contrase√±a institucional."""
    },
    {
        "question": "¬øQu√© hago si mi videoconferencia no carga correctamente?",
        "synonyms": [
            "videoconferencia error", "fallo en videoconferencia", "no carga la videollamada"
        ],
        "answer": """Verifica tu conexi√≥n a internet e intenta ingresar nuevamente. 
Si el problema persiste, contacta a Educaci√≥n Virtual."""
    },
    {
        "question": "¬øC√≥mo me comunico con mis docentes en la plataforma?",
        "synonyms": [
            "contactar profesores", "mensajer√≠a interna", "enviar mensaje a docente"
        ],
        "answer": """Puedes utilizar la mensajer√≠a interna del aula virtual 
o el correo institucional del docente."""
    },
    {
        "question": "¬øC√≥mo s√© si mi tarea fue enviada correctamente?",
        "synonyms": [
            "enviar tarea", "tarea confirmaci√≥n", "subir tarea con √©xito"
        ],
        "answer": """La plataforma te enviar√° una confirmaci√≥n. Si no la recibes, revisa tu conexi√≥n y vuelve a intentarlo."""
    }
]

faq_list += [
    {
        "question": "¬øHay examen de admisi√≥n en la UMA?",
        "synonyms": [
            "examen", "exam", "pr√≥ximo examen", "fechas de examen",
            "admision exam", "examen de admisi√≥n", "pr√≥ximo examen de admisi√≥n"
        ],
        "answer": """üìù Prep√°rate para nuestro pr√≥ximo examen de admisi√≥n. Conoce las fechas y requisitos en:
<a href='https://uma.edu.pe/admisionpregrado/'>Examen de Admisi√≥n UMA</a>"""
    },
    {
        "question": "¬øQu√© carreras ofrece la UMA?",
        "synonyms": [
            "carreras", "programas de pregrado", "opciones de carrera",
            "licenciaturas", "qu√© se estudia en UMA"
        ],
        "answer": """üìö En la UMA ofrecemos diversas carreras de pregrado en Ingenier√≠a, Negocios, Ciencias de la Salud y m√°s.
Consulta nuestra lista completa aqu√≠: <a href='https://uma.edu.pe/'>Carreras UMA</a>"""
    },
    {
        "question": "¬øOfrecen maestr√≠as en la UMA?",
        "synonyms": [
            "maestr√≠as", "estudios de posgrado", "MBA", "salud p√∫blica", "maestr√≠a"
        ],
        "answer": """üéì La UMA ofrece maestr√≠as como MBA y Salud P√∫blica. 
Encuentra m√°s informaci√≥n en:
<a href='https://uma.edu.pe/mba/'>Maestr√≠a en Administraci√≥n de Empresas - MBA</a><br>
<a href='https://uma.edu.pe/maestria-en-salud-publica/'>Maestr√≠a en Salud P√∫blica UMA</a>"""
    },
    {
        "question": "¬øTienen programas de especializaci√≥n?",
        "synonyms": [
            "especializaci√≥n", "programas especializados", "segunda especialidad",
            "posgrado enfermer√≠a", "posgrado farmacia"
        ],
        "answer": """üè• Contamos con programas de Segunda Especializaci√≥n Profesional en Enfermer√≠a, Farmacia y m√°s. 
Revisa nuestros programas aqu√≠: <a href='https://uma.edu.pe/psee/'>Especializaciones UMA</a>"""
    },
    {
        "question": "¬øOfrecen diplomados en la UMA?",
        "synonyms": [
            "diplomado", "diplomados", "estudios cortos posgrado",
            "especializaci√≥n corta"
        ],
        "answer": """üìú Explora nuestros diplomados en:
- Toxicolog√≠a Ambiental y Seguridad Alimentaria
- Seguridad Alimentaria
- Asuntos Regulatorios del Sector Farmac√©utico
- Enfermedades cr√≥nicas no transmisibles
- Salud Mental Comunitaria."""
    },
    {
        "question": "¬øC√≥mo es la admisi√≥n en la UMA?",
        "synonyms": [
            "admisi√≥n", "admision", "ingreso a la UMA", "requisitos de admisi√≥n"
        ],
        "answer": """üìÑ ¬øQuieres estudiar en la UMA? Conoce nuestros requisitos y procesos de admisi√≥n en:
<a href='https://uma.edu.pe/admisionpregrado/'>Admisi√≥n UMA</a>"""
    },
    {
        "question": "¬øQu√© carreras de ingenier√≠a tienen?",
        "synonyms": [
            "ingenier√≠a", "facultad de ingenier√≠a", "ingenier√≠a de sistemas", "industrial",
            "inteligencia artificial"
        ],
        "answer": """üñ•Ô∏è Nuestra Facultad de Ingenier√≠a y Negocios ofrece carreras como:
- Ingenier√≠a de Inteligencia Artificial
- Ingenier√≠a de Sistemas (Nuevo)
- Ingenier√≠a Industrial (Nuevo)
üìå"""
    },
    {
        "question": "¬øOfrecen la carrera de Derecho?",
        "synonyms": [
            "derecho", "facultad de derecho", "leyes", "carrera legal"
        ],
        "answer": """‚öñÔ∏è La carrera de Derecho ahora est√° disponible en la UMA. 
Consulta m√°s informaci√≥n aqu√≠: <a href='https://uma.edu.pe/derecho/'>Derecho UMA</a>"""
    },
    {
        "question": "¬øTienen programas de administraci√≥n?",
        "synonyms": [
            "administraci√≥n", "negocios", "marketing", "contabilidad y finanzas",
            "administraci√≥n de empresas"
        ],
        "answer": """üìä La Facultad de Ingenier√≠a y Negocios ofrece Administraci√≥n en:
- Empresas (Nuevo)
- Negocios Internacionales
- Marketing
- Contabilidad y Finanzas
üìå"""
    },
    {
        "question": "¬øOfrecen la carrera de Farmacia?",
        "synonyms": [
            "farmacia", "bioqu√≠mica", "facultad de farmacia", "farmac√©utico"
        ],
        "answer": """üíä Nuestra Facultad de Farmacia y Bioqu√≠mica ofrece la carrera de Farmacia y Bioqu√≠mica.
Consulta m√°s informaci√≥n aqu√≠: <a href='https://uma.edu.pe/'>Farmacia UMA</a>"""
    },
    {
        "question": "¬øQu√© carreras de salud ofrece la UMA?",
        "synonyms": [
            "salud", "ciencias de la salud", "carrera de enfermer√≠a", "nutrici√≥n y diet√©tica",
            "psicolog√≠a"
        ],
        "answer": """üè• La Facultad de Ciencias de la Salud de la UMA incluye programas como:
- Tecnolog√≠a M√©dica en Laboratorio Cl√≠nico
- Tecnolog√≠a M√©dica en Terapia F√≠sica y Rehabilitaci√≥n
- Enfermer√≠a
- Nutrici√≥n y Diet√©tica
- Psicolog√≠a
üìå"""
    },
    {
        "question": "¬øHay un MBA en la UMA?",
        "synonyms": [
            "mba", "maestr√≠a en administraci√≥n", "posgrado administraci√≥n"
        ],
        "answer": """üéì La UMA ofrece la Maestr√≠a en Administraci√≥n de Empresas (MBA) (Nuevo). 
üìå M√°s informaci√≥n: <a href='https://uma.edu.pe/mba/'>UMA MBA</a>"""
    },
    {
        "question": "¬øTienen la carrera de Psicolog√≠a?",
        "synonyms": [
            "psicolog√≠a", "facultad de psicolog√≠a", "carrera de psicolog√≠a"
        ],
        "answer": """üß† La carrera de Psicolog√≠a en la UMA prepara profesionales para trabajar en hospitales, 
empresas y centros educativos. M√°s informaci√≥n aqu√≠: <a href='https://uma.edu.pe/psicologia/'>Psicolog√≠a UMA</a>"""
    },
    {
        "question": "¬øOfrecen especializaciones en Enfermer√≠a?",
        "synonyms": [
            "enfermer√≠a", "especializaci√≥n en enfermer√≠a", "cuidados intensivos",
            "centro quir√∫rgico"
        ],
        "answer": """üè• La UMA ofrece especializaciones en Enfermer√≠a, incluyendo:
- Cuidados Intensivos
- Salud Familiar y Comunitaria
- Emergencias y Desastres
- Centro Quir√∫rgico
üìå M√°s informaci√≥n aqu√≠: <a href='https://uma.edu.pe/psee/'>Especializaci√≥n en Enfermer√≠a</a>"""
    },
    {
        "question": "¬øQu√© hay sobre Urolog√≠a?",
        "synonyms": [
            "urolog√≠a", "especialidad urolog√≠a", "cirug√≠a urol√≥gica"
        ],
        "answer": """ü©∫ La UMA ahora ofrece la especializaci√≥n en Urolog√≠a (Nuevo). 
üìå M√°s informaci√≥n aqu√≠: <a href='https://uma.edu.pe/see-en-urologia/'>Especializaci√≥n en Urolog√≠a</a>"""
    },
    {
        "question": "¬øTienen especialidad en Farmacia?",
        "synonyms": [
            "farmacia especialidad", "asuntos regulatorios farmacia",
            "segunda especialidad farmacia"
        ],
        "answer": """üíä Segunda Especialidad en Farmacia:
- Asuntos Regulatorios del Sector Farmac√©utico (Nuevo)
üìå M√°s informaci√≥n: <a href='https://uma.edu.pe/asuntos-regulatorios-en-el-sector-farmaceutico/'>Especializaci√≥n en Farmacia</a>"""
    },
    {
        "question": "¬øC√≥mo puedo contact a la UMA?",
        "synonyms": [
            "contactor", "tel√©fono admisi√≥n", "oficina de admisi√≥n", "ayuda"
        ],
        "answer": """üìû ¬øNecesitas ayuda? Puedes contactar con nuestra oficina de admisi√≥n:<br><br>
- Ms. Katya Aponte: <a href="#" class="phone-link" data-phone="51982887246">982 887 246</a> | <a href="mailto:katia.aponte@uma.edu.pe">katia.aponte@uma.edu.pe</a><br>
- Ms. Sandy Le√≥n: <a href="#" class="phone-link" data-phone="51923032722">923 032 722</a> | <a href="mailto:sandy.leon@uma.edu.pe">sandy.leon@uma.edu.pe</a><br>
- Ms. Esperanza P√©rez: <a href="#" class="phone-link" data-phone="51923319253">923 319 253</a> | <a href="mailto:esperanza.perez@uma.edu.pe">esperanza.perez@uma.edu.pe</a><br>
- Ms. Antuanette Fern√°ndez: <a href="#" class="phone-link" data-phone="51922821832">922 821 832</a> | <a href="mailto:jahaira.fernandez@uma.edu.pe">jahaira.fernandez@uma.edu.pe</a><br>
- Ms. Karol Padilla: <a href="#" class="phone-link" data-phone="51914569310">914 569 310</a> | <a href="mailto:karol.padilla@uma.edu.pe">karol.padilla@uma.edu.pe</a><br>"""
    }
]


# We combine question + synonyms into a single text for each entry
def create_faq_embedding_text(faq):
    # E.g. "¬øCu√°ndo inicia la matr√≠cula...? sin synonyms + synonyms joined with space"
    synonyms_text = " ".join(faq["synonyms"])
    return faq["question"] + " " + synonyms_text

# 4) LOAD STRONG EMBEDDING MODEL
faq_model = SentenceTransformer("sentence-transformers/multi-qa-mpnet-base-dot-v1")

# Precompute embeddings for each FAQ (question + synonyms)
faq_texts = [create_faq_embedding_text(faq) for faq in faq_list]
faq_embeddings = faq_model.encode(faq_texts, convert_to_tensor=True)

@app.route('/get_response', methods=['POST'])
def get_response():
    data = request.get_json()
    query = data.get("query", "")
    corrected_query = correct_spelling_internal(query)

    # 1) Try matching with the FAQ list (embedding-based)
    query_embedding = faq_model.encode(corrected_query, convert_to_tensor=True)
    scores = util.pytorch_cos_sim(query_embedding, faq_embeddings).cpu().numpy().flatten()
    best_index = int(np.argmax(scores))
    best_score = float(scores[best_index])

    # If above threshold, return EXACT FAQ answer
    THRESHOLD_FAQ = 0.75
    if best_score >= THRESHOLD_FAQ:
        return jsonify({
            "best_doc": faq_list[best_index]["answer"],
            "best_score": best_score,
            "corrected_query": corrected_query,
            "is_faq": True
        })

    # 2) Otherwise, fallback to TF-IDF
    best_doc, best_score_tfidf = get_best_doc_and_score(corrected_query)
    return jsonify({
        "best_doc": best_doc,
        "best_score": float(best_score_tfidf),
        "corrected_query": corrected_query,
        "is_faq": False
    })

# ----------------------------------------------------------------
# 5) WHISPER FOR SPEECH-TO-TEXT
# ----------------------------------------------------------------
device = "cuda" if torch.cuda.is_available() else "cpu"
# If "large" fails due to memory, use "medium" or "small"
whisper_model = whisper.load_model("medium").to(device)

def transcribe_audio(audio_data):
    try:
        audio, _ = sf.read(io.BytesIO(audio_data))
        audio = np.array(audio, dtype=np.float32)
        result = whisper_model.transcribe(audio, language="es")
        return result["text"]
    except Exception as e:
        print("Error in transcription:", str(e))
        return ""

@app.route('/speech_to_text_stream', methods=['POST'])
def speech_to_text_stream():
    def generate():
        while True:
            audio_chunk = request.stream.read(4096)
            if not audio_chunk:
                break
            text = transcribe_audio(audio_chunk)
            yield f"data: {text}\n\n"
    return Response(generate(), mimetype="text/event-stream")

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port, debug=True)
